# Implementation Plan: 自动评分系统

## Overview

本实施计划将评教系统从手动评分升级为基于 Deepseek API 的自动评分系统。实施分为数据库改造、核心功能开发、前端集成和测试验证四个阶段，采用增量开发方式，每个阶段都包含测试和验证。

## Tasks

- [x] 1. 数据库模型和迁移
  - 创建7个新数据表和扩展2个现有表
  - 实现数据库迁移脚本
  - _Requirements: 3.1, 11.1, 11.2_

- [x] 2. 文件解析模块
  - [x] 2.1 实现文件解析器基础类
    - 创建 FileParser 类，支持 docx、pdf、pptx 格式解析
    - 实现文件类型检测和错误处理
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
  
  - [x] 2.2 编写文件解析器属性测试
    - **Property 8: 不支持文件格式错误处理**
    - **Validates: Requirements 4.4**
  
  - [x] 2.3 编写文件解析器单元测试
    - 测试 docx、pdf、pptx 文件解析
    - 测试空文件和损坏文件处理
    - _Requirements: 4.1, 4.2, 4.3, 4.5_

- [x] 3. 提示词模板管理模块
  - [x] 3.1 实现模板管理器
    - 创建 TemplateManager 类
    - 实现模板的创建、查询、更新功能
    - 实现提示词构建功能
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9_
  
  - [x] 3.2 创建5类文件的默认提示词模板
    - 实现教案评分模板
    - 实现教学反思评分模板
    - 实现教研/听课记录评分模板
    - 实现成绩/学情分析评分模板
    - 实现课件评分模板
    - _Requirements: 3.1_
  
  - [x] 3.3 编写模板管理器属性测试
    - **Property 7: 提示词模板结构完整性**
    - **Validates: Requirements 3.2, 3.3, 3.4, 3.5, 3.6, 3.7**
  
  - [x] 3.4 编写模板管理器单元测试
    - 测试模板创建和查询
    - 测试提示词构建功能
    - _Requirements: 3.8, 3.9_

- [x] 4. Deepseek API 集成
  - [x] 4.1 实现 API 客户端
    - 创建 DeepseekAPIClient 类
    - 实现 API 调用、重试机制、超时处理
    - 实现响应格式验证
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_
  
  - [x] 4.2 编写 API 客户端属性测试
    - **Property 4: API 调用失败处理**
    - **Property 5: API 返回格式验证**
    - **Property 6: API 超时重试机制**
    - **Validates: Requirements 2.5, 2.6, 2.7**
  
  - [x] 4.3 编写 API 客户端单元测试
    - 测试 API 配置
    - 测试错误处理和重试逻辑
    - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 5. 自动评分引擎
  - [x] 5.1 实现评分引擎核心逻辑
    - 创建 ScoringEngine 类
    - 实现否决项检查流程
    - 实现核心指标评分
    - 实现加分项计算和限制
    - 实现等级映射
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 5.9, 5.10, 5.11, 5.12_
  
  - [x] 5.2 编写评分引擎属性测试
    - **Property 1: 文件提交触发评分流程**
    - **Property 2: 文件类型与模板映射**
    - **Property 3: API 调用结果存储**
    - **Property 10: 否决项检查流程**
    - **Property 11: 加分项上限限制**
    - **Property 12: 得分等级映射**
    - **Validates: Requirements 1.1, 1.3, 1.5, 5.1-5.12**
  
  - [x] 5.3 编写评分引擎单元测试
    - 测试等级边界值（59、60、79、80、89、90）
    - 测试否决项触发场景
    - 测试加分项计算
    - _Requirements: 5.9, 5.10, 5.11, 5.12_

- [x] 6. Checkpoint - 核心模块测试
  - 确保所有核心模块测试通过，询问用户是否有问题

- [x] 7. 复核管理模块
  - [x] 7.1 实现复核管理器
    - 创建 ReviewManager 类
    - 实现异议提交功能
    - 实现人工复核功能
    - 实现随机抽查功能
    - 实现一致性统计功能
    - 实现评分确认和公示功能
    - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8, 8.9, 8.10, 8.11, 8.12, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_
  
  - [x] 7.2 编写复核管理器属性测试
    - **Property 19: 异议提交表单验证**
    - **Property 20: 异议提交通知管理员**
    - **Property 21: 人工评分覆盖自动评分**
    - **Property 22: 评分结果确认流程**
    - **Property 23: 全员确认后允许公示**
    - **Property 24: 评分调整审计日志**
    - **Property 25: 抽查样本状态标记**
    - **Property 26: 复核结果记录**
    - **Property 27: 一致性比例计算**
    - **Validates: Requirements 8.3, 8.4, 8.6, 8.7-8.11, 9.3-9.6**
  
  - [x] 7.3 编写复核管理器单元测试
    - 测试异议提交和处理流程
    - 测试随机抽查功能
    - 测试一致性统计
    - _Requirements: 8.2, 8.5, 8.12, 9.1, 9.2_

- [x] 8. 任务管理模块扩展
  - [x] 8.1 扩展任务管理器
    - 扩展 EvaluationAssignmentTask 模型
    - 实现文件类型配置功能
    - 实现加分项配置功能
    - 实现截止时间检查和自动否决
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_
  
  - [x] 8.2 编写任务管理器属性测试
    - **Property 13: 任务创建后自动分发**
    - **Property 14: 超时未提交触发否决**
    - **Validates: Requirements 6.4, 6.5**
  
  - [x] 8.3 编写任务管理器单元测试
    - 测试任务创建和配置
    - 测试截止时间检查
    - _Requirements: 6.1, 6.2, 6.3_

- [x] 9. 文件提交流程优化
  - [x] 9.1 扩展文件提交功能
    - 扩展 MaterialSubmission 模型
    - 实现文件类型校验
    - 实现文件状态管理
    - 实现文件重新上传和覆盖
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_
  
  - [x] 9.2 编写文件提交属性测试
    - **Property 15: 文件类型校验**
    - **Property 16: 文件上传状态更新**
    - **Property 17: 文件重新上传覆盖**
    - **Property 18: 评分结果展示完整性**
    - **Validates: Requirements 7.1-7.6**
  
  - [x] 9.3 编写文件提交单元测试
    - 测试文件类型校验
    - 测试文件状态更新
    - 测试重新上传流程
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 10. 数据安全和权限控制
  - [x] 10.1 实现文件加密存储
    - 实现文件加密和解密功能
    - 实现文件哈希计算
    - 实现文件元数据记录
    - _Requirements: 11.1, 11.2_
  
  - [x] 10.2 实现权限控制
    - 实现基于角色的文件访问控制
    - 实现文件下载审计日志
    - _Requirements: 11.3, 11.4, 11.5, 11.6_
  
  - [x] 10.3 编写安全模块属性测试
    - **Property 29: 文件加密存储**
    - **Property 30: 文件元数据记录**
    - **Property 31: 基于角色的文件访问控制**
    - **Property 32: 文件下载审计日志**
    - **Validates: Requirements 11.1-11.6**
  
  - [x] 10.4 编写安全模块单元测试
    - 测试文件加密和解密
    - 测试权限验证
    - 测试审计日志
    - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6_

- [x] 11. Checkpoint - 业务逻辑测试
    - 自动运行所有业务逻辑测试用例
    - 验证测试通过率≥100%，失败则自动重试3次
    - 生成测试报告并保存到项目根目录/test_reports/business_logic_report.md
    - _Requirements: 8.1-8.12, 9.1-9.6, 6.1-6.5, 7.1-7.6, 11.1-11.6_

- [x] 12. 后端 API 实现
  - [x] 12.1 实现提示词模板管理 API
    - GET /api/scoring/templates - 获取模板列表
    - GET /api/scoring/templates/{file_type} - 获取模板详情
    - POST /api/scoring/templates - 创建模板
    - PUT /api/scoring/templates/{id} - 更新模板
    - _Requirements: 3.8, 3.9_
  
  - [x] 12.2 实现自动评分 API
    - POST /api/scoring/score/{submission_id} - 触发单个文件评分
    - POST /api/scoring/batch-score - 批量评分
    - GET /api/scoring/records/{submission_id} - 获取评分结果
    - _Requirements: 1.1, 1.4, 1.5, 1.6, 1.7_
  
  - [x] 12.3 实现复核管理 API
    - POST /api/scoring/appeals - 提交异议
    - GET /api/scoring/appeals - 获取异议列表
    - POST /api/scoring/manual-review - 人工复核
    - POST /api/scoring/confirm/{scoring_record_id} - 教师确认评分
    - POST /api/scoring/random-sample - 随机抽查
    - POST /api/scoring/review-result - 记录复核结果
    - POST /api/scoring/publish/{task_id} - 公示结果
    - _Requirements: 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8, 8.9, 8.10, 9.1, 9.2, 9.3, 9.4, 9.5_
  
  - [x] 12.4 实现统计分析 API
    - GET /api/scoring/consistency - 一致性统计
    - GET /api/scoring/export - 导出评分结果
    - _Requirements: 9.6, 10.1, 10.2, 10.3, 10.4, 10.5_
  
  - [x] 12.5 实现扩展接口 API
    - GET /api/external/scoring-results - 查询评分结果
    - POST /api/external/sync-teachers - 同步教师信息
    - POST /api/external/sync-awards - 同步获奖信息
    - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5_
  
  - [x] 12.6 编写 API 属性测试
    - **Property 33: API 密钥验证**
    - **Property 34: API 调用日志记录**
    - **Validates: Requirements 12.4, 12.5**
  
  - [x] 12.7 编写 API 集成测试
    - 测试完整的评分流程（上传 → 评分 → 复核 → 公示）
    - 测试异议处理流程
    - 测试导出功能
    - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 13. 管理端前端集成
  - [x] 13.1 扩展考评任务管理界面
    - 在考评任务列表的"操作"菜单中添加"评分"按钮
    - 实现评分对话框（显示待评分文件列表）
    - 实现批量评分功能
    - 实现评分结果查看
    - _Requirements: 1.1, 1.6, 1.7_
  
  - [x] 13.2 实现提示词模板配置界面
    - 创建模板管理页面
    - 实现模板列表展示
    - 实现模板编辑功能
    - _Requirements: 3.8, 3.9_
  
  - [x] 13.3 实现复核管理界面
    - 创建异议列表页面
    - 实现人工复核对话框
    - 实现随机抽查功能
    - 实现一致性统计展示
    - 实现公示功能
    - _Requirements: 8.2, 8.5, 8.12, 9.1, 9.2, 9.6_
  
  - [x] 13.4 实现评分结果导出功能
    - 在考评任务管理中添加"导出评分结果"按钮
    - 实现筛选条件设置
    - 实现 Excel 导出
    - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 14. 教师端前端集成
  - [x] 14.1 扩展评分结果展示
    - 在材料提交记录中显示评分结果
    - 显示评分明细（得分、等级、扣分理由）
    - _Requirements: 7.6, 8.1_
  
  - [x] 14.2 实现异议申请功能
    - 在评分结果中添加"提交异议"按钮
    - 实现异议申请对话框
    - _Requirements: 8.2, 8.3_
  
  - [x] 14.3 实现评分确认功能
    - 在评分结果中添加"确认评分"按钮
    - 实现确认对话框
    - _Requirements: 8.8, 8.9_

- [x] 15. Checkpoint - 前端集成测试
    - 自动运行前端集成测试脚本（npm run test:frontend）
    - 验证页面功能和接口调用成功率≥100%
    - 生成测试报告并保存到项目根目录/test_reports/frontend_report.md
    - _Requirements: 1.1, 1.6, 1.7, 3.8, 3.9, 8.2, 8.5, 8.12, 9.1, 9.2, 9.6, 10.1-10.5_
- [x] 16. 端到端测试和验证
  - [x] 16.1 执行完整流程测试
    - 测试管理端创建任务 → 教师端上传文件 → 自动评分 → 教师查看结果
    - 测试异议申请 → 人工复核 → 教师确认 → 公示结果
    - 测试随机抽查和一致性统计
    - _Requirements: 13.1, 13.2, 13.3, 13.4, 13.5, 13.6, 13.7, 13.8_
  
  - [x] 16.2 执行性能测试
    - 测试单个文件评分响应时间（目标≤10秒）
    - 测试批量评分100份文件（目标≤10分钟）
    - _Requirements: 1.6, 1.7_
  
  - [x] 16.3 执行一致性验证
    - 准备测试数据集（至少100份文件）
    - 执行自动评分
    - 执行人工复核
    - 计算一致性比例（目标≥95%）
    - _Requirements: 13.6_

- [x] 17. 试运行配置
  - [x] 17.1 实现试运行模式
    - 添加系统配置：试运行模式开关
    - 在试运行模式下，自动记录自动评分与预设标准的差异（无需人工复核）
    - 生成差异报告并保存到项目根目录/test_reports/trial_run_diff_report.md
    - _Requirements: 14.1, 14.2_
  
  - [x] 17.2 实现一致性报告生成
    - 实现一致性统计功能
    - 实现差异原因分析
    - 生成试运行报告
    - _Requirements: 14.3, 14.4, 14.5_

- [x] 18. 文档和部署
  - [x] 18.1 编写用户手册
    - 管理端操作手册（如何配置模板、如何评分、如何复核）
    - 教师端操作手册（如何查看结果、如何提交异议）
  
  - [x] 18.2 编写部署文档
    - 环境配置说明
    - 数据库迁移步骤
    - API 密钥配置
    - 系统启动和监控
  
  - [x] 18.3 准备上线
    - 执行数据库迁移
    - 配置 Deepseek API 密钥
    - 导入默认提示词模板
    - 配置系统为试运行模式

- [x] 19. Final Checkpoint - 系统验收
  - 确保所有功能正常，所有测试通过，询问用户是否可以上线

## Notes

- 所有任务都是必需的，包括测试任务
- 每个任务都引用了具体的需求编号，确保可追溯性
- Checkpoint 任务确保增量验证，及时发现问题
- 属性测试验证通用正确性属性，单元测试验证具体场景
- 前端集成不改变教师端原有功能，只扩展评分结果展示和异议功能
- 管理端评分功能集成在考评任务管理的"操作"菜单中

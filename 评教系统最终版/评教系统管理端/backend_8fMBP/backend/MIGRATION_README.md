# 自动评分系统数据库迁移说明

## 概述

本迁移脚本用于将评教系统从手动评分模式升级为基于 Deepseek API 的自动评分系统。

## 迁移内容

### 1. 新增数据表（7个）

| 表名 | 说明 |
|------|------|
| `scoring_templates` | 评分模板表 - 管理5类文件的提示词模板 |
| `scoring_records` | 评分记录表 - 存储每次评分的详细结果 |
| `scoring_appeals` | 评分异议表 - 处理教师对评分结果的异议 |
| `review_records` | 复核记录表 - 记录人工复核的详细信息 |
| `bonus_items` | 加分项表 - 管理教师的加分项 |
| `scoring_logs` | 评分日志表 - 记录所有评分相关操作 |
| `system_scoring_config` | 系统评分配置表 - 管理系统级别的评分配置 |

### 2. 扩展现有表

#### MaterialSubmission 表新增字段：
- `scoring_status` - 评分状态（pending/scoring/scored/failed）
- `parsed_content` - 解析后的文本内容
- `file_hash` - 文件哈希值
- `encrypted_path` - 加密后的文件路径

#### EvaluationAssignmentTask 表新增字段：
- `required_file_types` - 必需文件类型列表（JSON）
- `bonus_enabled` - 是否启用加分项
- `max_bonus_score` - 最大加分值（默认10分）
- `auto_scoring_enabled` - 是否启用自动评分

### 3. 初始化配置

迁移脚本会自动创建以下系统配置：

1. **Deepseek API 配置**
   - API地址、密钥、模型参数
   - 重试次数、超时设置

2. **试运行模式配置**
   - 启用试运行模式
   - 要求全量人工复核
   - 试运行期限（30天）

3. **评分规则配置**
   - 等级划分标准
   - 最大加分值
   - 通用否决项

## 使用方法

### 执行迁移

```bash
cd 评教系统最终版/评教系统管理端/backend_8fMBP/backend
python migrate_scoring_system.py
```

### 回滚迁移（仅用于开发测试）

```bash
python migrate_scoring_system.py --rollback
```

**警告**：回滚操作会删除所有自动评分系统相关的表和数据，请谨慎使用！

## 迁移验证

迁移成功后，脚本会自动验证：
- ✓ 所有新表是否创建成功
- ✓ 现有表的新字段是否添加成功
- ✓ 系统配置是否初始化完成

## 注意事项

1. **备份数据库**：在执行迁移前，请务必备份现有数据库
2. **停止服务**：建议在系统维护时间执行迁移，避免影响用户使用
3. **测试环境**：建议先在测试环境执行迁移，验证无误后再在生产环境执行
4. **API密钥**：迁移脚本中包含 Deepseek API 密钥，请确保密钥有效

## 迁移后的下一步

1. 重启后端服务
2. 验证新增的API接口
3. 配置5类文件的提示词模板
4. 测试自动评分功能
5. 进行试运行验证

## 故障排除

### 问题：迁移失败，提示表已存在
**解决方案**：这是正常情况，脚本会跳过已存在的表

### 问题：添加列失败
**解决方案**：检查数据库权限，确保有ALTER TABLE权限

### 问题：系统配置初始化失败
**解决方案**：检查数据库连接，确保 system_scoring_config 表创建成功

## 技术支持

如遇到问题，请查看：
1. 迁移脚本输出的详细日志
2. 数据库错误日志
3. 联系开发团队

---

**迁移脚本版本**: 1.0.0  
**创建日期**: 2026-02-03  
**最后更新**: 2026-02-03

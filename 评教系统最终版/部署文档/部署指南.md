# 评教系统自动评分模块部署指南

## 目录
1. [系统要求](#系统要求)
2. [环境配置](#环境配置)
3. [数据库迁移](#数据库迁移)
4. [API 密钥配置](#api-密钥配置)
5. [系统启动](#系统启动)
6. [系统监控](#系统监控)
7. [故障排查](#故障排查)
8. [备份和恢复](#备份和恢复)

---

## 系统要求

### 硬件要求

- **CPU**: 至少 2 核心（推荐 4 核心或以上）
- **内存**: 至少 4GB（推荐 8GB 或以上）
- **存储**: 至少 50GB 可用空间（根据文件数量可能需要更多）
- **网络**: 稳定的互联网连接（用于调用 Deepseek API）

### 软件要求

- **操作系统**: Linux（推荐 Ubuntu 20.04 LTS 或 CentOS 7+）或 Windows Server 2016+
- **Python**: 3.8 或更高版本
- **Node.js**: 14.0 或更高版本（用于前端构建）
- **数据库**: SQLite 3.0 或更高版本（或 MySQL 5.7+）
- **Web 服务器**: Nginx 或 Apache（用于反向代理）

### 浏览器要求

- Google Chrome 90+
- Microsoft Edge 90+
- Mozilla Firefox 88+

---

## 环境配置

### 1. 安装 Python 依赖

#### 在 Linux 上安装

```bash
# 更新系统包
sudo apt-get update
sudo apt-get upgrade -y

# 安装 Python 和 pip
sudo apt-get install -y python3 python3-pip python3-venv

# 安装系统依赖
sudo apt-get install -y libpq-dev build-essential

# 创建虚拟环境
python3 -m venv /opt/evaluation-system/venv

# 激活虚拟环境
source /opt/evaluation-system/venv/bin/activate

# 升级 pip
pip install --upgrade pip setuptools wheel
```

#### 在 Windows 上安装

```powershell
# 下载并安装 Python 3.8+（从 python.org）
# 在安装时勾选 "Add Python to PATH"

# 创建虚拟环境
python -m venv C:\evaluation-system\venv

# 激活虚拟环境
C:\evaluation-system\venv\Scripts\activate

# 升级 pip
python -m pip install --upgrade pip setuptools wheel
```

### 2. 安装 Python 包

```bash
# 激活虚拟环境（如果还未激活）
source /opt/evaluation-system/venv/bin/activate  # Linux
# 或
C:\evaluation-system\venv\Scripts\activate  # Windows

# 安装依赖包
pip install -r requirements.txt
```

**requirements.txt 内容**：

```
FastAPI==0.104.1
uvicorn==0.24.0
SQLAlchemy==2.0.23
python-docx==0.8.11
PyPDF2==3.0.1
python-pptx==0.6.21
requests==2.31.0
cryptography==41.0.7
python-multipart==0.0.6
pydantic==2.5.0
pydantic-settings==2.1.0
```

### 3. 安装 Node.js 依赖

#### 在 Linux 上安装

```bash
# 安装 Node.js（使用 NodeSource 仓库）
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

#### 在 Windows 上安装

```powershell
# 下载并安装 Node.js（从 nodejs.org）
# 选择 LTS 版本

# 验证安装
node --version
npm --version
```

### 4. 安装前端依赖

```bash
# 进入前端目录
cd /path/to/frontend

# 安装依赖
npm install

# 构建前端
npm run build
```

### 5. 配置环境变量

创建 `.env` 文件在项目根目录：

```bash
# 数据库配置
DATABASE_URL=sqlite:///./evaluation.db
# 或使用 MySQL
# DATABASE_URL=mysql+pymysql://user:password@localhost:3306/evaluation

# API 配置
DEEPSEEK_API_KEY=sk-your-api-key-here
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat

# 应用配置
APP_ENV=production
APP_DEBUG=false
APP_SECRET_KEY=your-secret-key-here
APP_CORS_ORIGINS=["https://yourdomain.com"]

# 文件存储配置
FILE_UPLOAD_DIR=/opt/evaluation-system/uploads
FILE_MAX_SIZE=52428800  # 50MB

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=/opt/evaluation-system/logs/app.log

# 试运行模式
TRIAL_RUN_MODE=true
```

### 6. 创建必要的目录

```bash
# 创建上传目录
mkdir -p /opt/evaluation-system/uploads

# 创建日志目录
mkdir -p /opt/evaluation-system/logs

# 创建备份目录
mkdir -p /opt/evaluation-system/backups

# 设置权限
chmod 755 /opt/evaluation-system/uploads
chmod 755 /opt/evaluation-system/logs
chmod 755 /opt/evaluation-system/backups
```

---

## 数据库迁移

### 1. 初始化数据库

#### 使用 SQLite（开发/小规模部署）

```bash
# 激活虚拟环境
source /opt/evaluation-system/venv/bin/activate

# 运行迁移脚本
python -m alembic upgrade head

# 或直接创建表
python scripts/init_db.py
```

#### 使用 MySQL（生产环境）

```bash
# 创建数据库
mysql -u root -p -e "CREATE DATABASE evaluation_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 创建用户
mysql -u root -p -e "CREATE USER 'eval_user'@'localhost' IDENTIFIED BY 'strong_password';"

# 授予权限
mysql -u root -p -e "GRANT ALL PRIVILEGES ON evaluation_system.* TO 'eval_user'@'localhost';"

# 刷新权限
mysql -u root -p -e "FLUSH PRIVILEGES;"

# 运行迁移
python -m alembic upgrade head
```

### 2. 导入默认数据

```bash
# 导入默认提示词模板
python scripts/import_templates.py

# 导入系统配置
python scripts/import_config.py

# 导入用户角色
python scripts/import_roles.py
```

### 3. 验证数据库

```bash
# 检查表是否创建成功
python scripts/check_db.py

# 输出应该显示所有表已创建
# Tables created:
# - scoring_templates
# - scoring_records
# - scoring_appeals
# - review_records
# - bonus_items
# - scoring_logs
# - material_submissions (extended)
# - evaluation_assignment_tasks (extended)
```

### 4. 备份初始数据库

```bash
# 备份数据库
cp /opt/evaluation-system/evaluation.db /opt/evaluation-system/backups/evaluation_initial.db

# 或使用 MySQL 备份
mysqldump -u eval_user -p evaluation_system > /opt/evaluation-system/backups/evaluation_initial.sql
```

---

## API 密钥配置

### 1. 获取 Deepseek API 密钥

1. 访问 [Deepseek 官网](https://www.deepseek.com)
2. 注册账户或登录
3. 进入 API 管理页面
4. 创建新的 API 密钥
5. 复制 API 密钥

### 2. 配置 API 密钥

#### 方法 1：环境变量

编辑 `.env` 文件：

```bash
DEEPSEEK_API_KEY=sk-your-api-key-here
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat
```

#### 方法 2：配置文件

编辑 `config/settings.py`：

```python
DEEPSEEK_API_KEY = "sk-your-api-key-here"
DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions"
DEEPSEEK_MODEL = "deepseek-chat"
DEEPSEEK_TEMPERATURE = 0.1
DEEPSEEK_MAX_TOKENS = 2000
DEEPSEEK_TIMEOUT = 30
DEEPSEEK_MAX_RETRIES = 3
```

### 3. 测试 API 连接

```bash
# 运行测试脚本
python scripts/test_api.py

# 输出应该显示：
# Testing Deepseek API connection...
# API connection successful!
# Model: deepseek-chat
# Available tokens: 1000000
```

### 4. 配置 API 速率限制

在 `config/settings.py` 中配置：

```python
# API 速率限制
API_RATE_LIMIT = 100  # 每分钟最多 100 个请求
API_RATE_LIMIT_WINDOW = 60  # 时间窗口（秒）

# 批量评分配置
BATCH_SCORING_BATCH_SIZE = 10  # 每批处理 10 个文件
BATCH_SCORING_DELAY = 1  # 批次之间的延迟（秒）
```

---

## 系统启动

### 1. 启动后端服务

#### 开发环境

```bash
# 激活虚拟环境
source /opt/evaluation-system/venv/bin/activate

# 启动 FastAPI 服务
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

#### 生产环境

```bash
# 使用 Gunicorn 启动
gunicorn -w 4 -b 0.0.0.0:8000 app.main:app

# 或使用 systemd 服务
sudo systemctl start evaluation-system
```

### 2. 启动前端服务

#### 开发环境

```bash
# 进入前端目录
cd /path/to/frontend

# 启动开发服务器
npm run dev
```

#### 生产环境

```bash
# 构建前端
npm run build

# 使用 Nginx 提供静态文件
# 配置见下文
```

### 3. 配置 Nginx 反向代理

创建 `/etc/nginx/sites-available/evaluation-system` 文件：

```nginx
upstream backend {
    server 127.0.0.1:8000;
}

server {
    listen 80;
    server_name yourdomain.com;

    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    # SSL 证书配置
    ssl_certificate /etc/ssl/certs/yourdomain.com.crt;
    ssl_certificate_key /etc/ssl/private/yourdomain.com.key;

    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    # 前端静态文件
    location / {
        root /opt/evaluation-system/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
    }

    # 文件上传
    location /uploads/ {
        alias /opt/evaluation-system/uploads/;
        expires 30d;
    }

    # 日志
    access_log /var/log/nginx/evaluation-system-access.log;
    error_log /var/log/nginx/evaluation-system-error.log;
}
```

启用站点：

```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/evaluation-system /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 4. 配置 Systemd 服务

创建 `/etc/systemd/system/evaluation-system.service` 文件：

```ini
[Unit]
Description=Evaluation System Backend
After=network.target

[Service]
Type=notify
User=www-data
WorkingDirectory=/opt/evaluation-system
Environment="PATH=/opt/evaluation-system/venv/bin"
ExecStart=/opt/evaluation-system/venv/bin/gunicorn -w 4 -b 127.0.0.1:8000 app.main:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用服务：

```bash
# 重新加载 systemd
sudo systemctl daemon-reload

# 启用服务
sudo systemctl enable evaluation-system

# 启动服务
sudo systemctl start evaluation-system

# 检查状态
sudo systemctl status evaluation-system
```

---

## 系统监控

### 1. 日志监控

#### 查看应用日志

```bash
# 实时查看日志
tail -f /opt/evaluation-system/logs/app.log

# 查看最后 100 行
tail -100 /opt/evaluation-system/logs/app.log

# 搜索错误
grep ERROR /opt/evaluation-system/logs/app.log
```

#### 查看 Nginx 日志

```bash
# 访问日志
tail -f /var/log/nginx/evaluation-system-access.log

# 错误日志
tail -f /var/log/nginx/evaluation-system-error.log
```

### 2. 性能监控

#### 监控 CPU 和内存

```bash
# 使用 top 命令
top -p $(pgrep -f "gunicorn")

# 或使用 htop
htop -p $(pgrep -f "gunicorn")
```

#### 监控数据库

```bash
# 检查数据库大小
du -sh /opt/evaluation-system/evaluation.db

# 或使用 MySQL
mysql -u eval_user -p -e "SELECT table_name, ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb FROM information_schema.tables WHERE table_schema = 'evaluation_system';"
```

### 3. 健康检查

#### API 健康检查

```bash
# 检查 API 是否正常运行
curl -s http://localhost:8000/api/health | jq .

# 输出应该显示：
# {
#   "status": "healthy",
#   "timestamp": "2024-01-01T00:00:00Z",
#   "version": "2.0.0"
# }
```

#### 数据库连接检查

```bash
# 运行检查脚本
python scripts/check_db_connection.py

# 输出应该显示：
# Database connection successful!
# Tables: 9
# Records: 1234
```

### 4. 设置监控告警

#### 使用 Prometheus 和 Grafana

1. 安装 Prometheus：

```bash
sudo apt-get install -y prometheus
```

2. 配置 Prometheus（`/etc/prometheus/prometheus.yml`）：

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'evaluation-system'
    static_configs:
      - targets: ['localhost:8000']
```

3. 安装 Grafana：

```bash
sudo apt-get install -y grafana-server
sudo systemctl start grafana-server
```

4. 访问 Grafana 仪表板：`http://localhost:3000`

---

## 故障排查

### 1. 常见错误

#### 错误：数据库连接失败

**症状**：应用启动时显示 "Database connection failed"

**解决方案**：

```bash
# 检查数据库文件是否存在
ls -la /opt/evaluation-system/evaluation.db

# 检查数据库权限
chmod 644 /opt/evaluation-system/evaluation.db

# 重新初始化数据库
python scripts/init_db.py
```

#### 错误：API 密钥无效

**症状**：评分时显示 "Invalid API key"

**解决方案**：

```bash
# 检查 API 密钥配置
grep DEEPSEEK_API_KEY .env

# 测试 API 连接
python scripts/test_api.py

# 更新 API 密钥
# 编辑 .env 文件并重启服务
sudo systemctl restart evaluation-system
```

#### 错误：文件上传失败

**症状**：上传文件时显示 "Upload failed"

**解决方案**：

```bash
# 检查上传目录权限
ls -la /opt/evaluation-system/uploads

# 修复权限
chmod 755 /opt/evaluation-system/uploads
chmod 755 /opt/evaluation-system/uploads/*

# 检查磁盘空间
df -h /opt/evaluation-system

# 清理旧文件
find /opt/evaluation-system/uploads -mtime +30 -delete
```

#### 错误：内存不足

**症状**：应用崩溃或响应缓慢

**解决方案**：

```bash
# 检查内存使用
free -h

# 增加虚拟内存
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 优化应用配置
# 减少 Gunicorn 工作进程数
# 编辑 /etc/systemd/system/evaluation-system.service
# 将 -w 4 改为 -w 2
```

### 2. 调试模式

启用调试模式以获取更详细的错误信息：

```bash
# 编辑 .env 文件
APP_DEBUG=true
LOG_LEVEL=DEBUG

# 重启服务
sudo systemctl restart evaluation-system

# 查看详细日志
tail -f /opt/evaluation-system/logs/app.log
```

### 3. 日志分析

```bash
# 查看最常见的错误
grep ERROR /opt/evaluation-system/logs/app.log | sort | uniq -c | sort -rn

# 查看特定时间范围的日志
grep "2024-01-01" /opt/evaluation-system/logs/app.log

# 导出日志用于分析
cat /opt/evaluation-system/logs/app.log | gzip > /opt/evaluation-system/backups/logs_$(date +%Y%m%d).log.gz
```

---

## 备份和恢复

### 1. 定期备份

#### 创建备份脚本

创建 `/opt/evaluation-system/scripts/backup.sh`：

```bash
#!/bin/bash

BACKUP_DIR="/opt/evaluation-system/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# 备份数据库
cp /opt/evaluation-system/evaluation.db $BACKUP_DIR/evaluation_$TIMESTAMP.db

# 备份上传的文件
tar -czf $BACKUP_DIR/uploads_$TIMESTAMP.tar.gz /opt/evaluation-system/uploads

# 备份配置文件
tar -czf $BACKUP_DIR/config_$TIMESTAMP.tar.gz /opt/evaluation-system/.env

# 删除 30 天前的备份
find $BACKUP_DIR -name "evaluation_*.db" -mtime +30 -delete
find $BACKUP_DIR -name "uploads_*.tar.gz" -mtime +30 -delete
find $BACKUP_DIR -name "config_*.tar.gz" -mtime +30 -delete

echo "Backup completed at $TIMESTAMP"
```

#### 设置定时备份

```bash
# 编辑 crontab
crontab -e

# 添加每天凌晨 2 点执行备份
0 2 * * * /opt/evaluation-system/scripts/backup.sh
```

### 2. 恢复数据

#### 恢复数据库

```bash
# 停止应用
sudo systemctl stop evaluation-system

# 恢复数据库
cp /opt/evaluation-system/backups/evaluation_20240101_020000.db /opt/evaluation-system/evaluation.db

# 启动应用
sudo systemctl start evaluation-system
```

#### 恢复上传的文件

```bash
# 停止应用
sudo systemctl stop evaluation-system

# 恢复文件
tar -xzf /opt/evaluation-system/backups/uploads_20240101_020000.tar.gz -C /

# 启动应用
sudo systemctl start evaluation-system
```

### 3. 灾难恢复计划

1. **备份策略**：
   - 每天自动备份数据库
   - 每周备份上传的文件
   - 每月备份完整系统

2. **恢复时间目标（RTO）**：
   - 数据库恢复：< 1 小时
   - 系统恢复：< 4 小时

3. **恢复点目标（RPO）**：
   - 数据丢失：< 1 天

---

## 安全建议

### 1. 访问控制

- 使用强密码（至少 12 个字符）
- 启用 HTTPS/SSL
- 配置防火墙规则
- 限制 API 访问

### 2. 数据保护

- 加密敏感数据
- 定期备份
- 限制文件访问权限
- 审计日志记录

### 3. 系统维护

- 定期更新依赖包
- 监控系统性能
- 定期检查日志
- 及时修复安全漏洞

---

## 性能优化

### 1. 数据库优化

```sql
-- 创建索引
CREATE INDEX idx_submission_status ON material_submissions(scoring_status);
CREATE INDEX idx_record_teacher ON scoring_records(teacher_id);
CREATE INDEX idx_appeal_status ON scoring_appeals(status);

-- 定期清理日志
DELETE FROM scoring_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

### 2. 缓存配置

在 `config/settings.py` 中配置：

```python
# Redis 缓存
REDIS_URL = "redis://localhost:6379/0"
CACHE_TTL = 3600  # 1 小时

# 缓存配置
CACHE_TEMPLATES = True
CACHE_CONSISTENCY_STATS = True
```

### 3. 批量操作优化

```python
# 批量评分配置
BATCH_SIZE = 10
BATCH_TIMEOUT = 300  # 5 分钟
BATCH_RETRY_COUNT = 3
```

---

## 升级指南

### 1. 备份当前系统

```bash
# 执行完整备份
/opt/evaluation-system/scripts/backup.sh
```

### 2. 停止服务

```bash
sudo systemctl stop evaluation-system
```

### 3. 更新代码

```bash
# 进入项目目录
cd /opt/evaluation-system

# 拉取最新代码
git pull origin main

# 或下载新版本
wget https://github.com/yourorg/evaluation-system/releases/download/v2.1.0/evaluation-system-2.1.0.tar.gz
tar -xzf evaluation-system-2.1.0.tar.gz
```

### 4. 更新依赖

```bash
# 激活虚拟环境
source /opt/evaluation-system/venv/bin/activate

# 更新 Python 依赖
pip install -r requirements.txt --upgrade

# 更新前端依赖
cd /opt/evaluation-system/frontend
npm install
npm run build
```

### 5. 运行迁移

```bash
# 运行数据库迁移
python -m alembic upgrade head
```

### 6. 启动服务

```bash
sudo systemctl start evaluation-system
```

### 7. 验证升级

```bash
# 检查服务状态
sudo systemctl status evaluation-system

# 检查 API 健康
curl -s http://localhost:8000/api/health | jq .

# 查看日志
tail -f /opt/evaluation-system/logs/app.log
```

---

## 支持和联系

- **技术支持邮箱**：support@school.edu
- **技术支持电话**：010-XXXX-XXXX
- **工作时间**：周一至周五 9:00-17:00
- **紧急联系**：emergency@school.edu

---

**文档版本**：1.0  
**最后更新**：2024年1月  
**适用系统版本**：评教系统 v2.0+

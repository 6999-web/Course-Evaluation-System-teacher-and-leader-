# 评教系统快速部署指南

本指南提供了快速部署评教系统自动评分模块的步骤。完整的部署文档请参考 `部署指南.md`。

## 前置条件

- Linux 服务器（Ubuntu 20.04 LTS 或 CentOS 7+）
- Python 3.8+
- Node.js 14+
- Deepseek API 密钥

## 快速部署步骤

### 第 1 步：准备环境（5 分钟）

```bash
# 1. 创建项目目录
sudo mkdir -p /opt/evaluation-system
cd /opt/evaluation-system

# 2. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 3. 升级 pip
pip install --upgrade pip setuptools wheel

# 4. 安装依赖
pip install -r requirements.txt
```

### 第 2 步：配置系统（5 分钟）

```bash
# 1. 创建 .env 文件
cat > .env << EOF
# 数据库配置
DATABASE_URL=sqlite:///./evaluation.db

# API 配置
DEEPSEEK_API_KEY=sk-your-api-key-here
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat

# 应用配置
APP_ENV=production
APP_SECRET_KEY=your-secret-key-here

# 文件存储
FILE_UPLOAD_DIR=/opt/evaluation-system/uploads
FILE_MAX_SIZE=52428800

# 试运行模式
TRIAL_RUN_MODE=true
EOF

# 2. 创建必要的目录
mkdir -p uploads logs backups

# 3. 设置权限
chmod 755 uploads logs backups
```

### 第 3 步：初始化数据库（5 分钟）

```bash
# 1. 激活虚拟环境
source venv/bin/activate

# 2. 初始化数据库
python scripts/init_db.py

# 3. 导入默认模板
python scripts/import_templates.py

# 4. 验证数据库
python scripts/check_db.py
```

### 第 4 步：构建前端（10 分钟）

```bash
# 1. 进入前端目录
cd frontend

# 2. 安装依赖
npm install

# 3. 构建前端
npm run build

# 4. 返回项目根目录
cd ..
```

### 第 5 步：启动服务（5 分钟）

```bash
# 1. 激活虚拟环境
source venv/bin/activate

# 2. 启动后端服务
gunicorn -w 4 -b 127.0.0.1:8000 app.main:app &

# 3. 配置 Nginx（见下文）

# 4. 启动 Nginx
sudo systemctl restart nginx
```

### 第 6 步：配置 Nginx（5 分钟）

```bash
# 1. 创建 Nginx 配置
sudo tee /etc/nginx/sites-available/evaluation-system > /dev/null << 'EOF'
upstream backend {
    server 127.0.0.1:8000;
}

server {
    listen 80;
    server_name yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    ssl_certificate /etc/ssl/certs/yourdomain.com.crt;
    ssl_certificate_key /etc/ssl/private/yourdomain.com.key;

    location / {
        root /opt/evaluation-system/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /uploads/ {
        alias /opt/evaluation-system/uploads/;
    }
}
EOF

# 2. 启用站点
sudo ln -s /etc/nginx/sites-available/evaluation-system /etc/nginx/sites-enabled/

# 3. 测试配置
sudo nginx -t

# 4. 重启 Nginx
sudo systemctl restart nginx
```

### 第 7 步：验证部署（5 分钟）

```bash
# 1. 检查后端服务
curl -s http://localhost:8000/api/health | jq .

# 2. 检查前端
curl -s https://yourdomain.com | head -20

# 3. 查看日志
tail -f /opt/evaluation-system/logs/app.log
```

## 部署完成！

系统现在应该已经可以访问了。

- **管理端**：https://yourdomain.com/admin
- **教师端**：https://yourdomain.com/teacher
- **API**：https://yourdomain.com/api

## 后续配置

### 1. 配置 Systemd 服务

```bash
# 创建服务文件
sudo tee /etc/systemd/system/evaluation-system.service > /dev/null << 'EOF'
[Unit]
Description=Evaluation System Backend
After=network.target

[Service]
Type=notify
User=www-data
WorkingDirectory=/opt/evaluation-system
Environment="PATH=/opt/evaluation-system/venv/bin"
ExecStart=/opt/evaluation-system/venv/bin/gunicorn -w 4 -b 127.0.0.1:8000 app.main:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 启用服务
sudo systemctl daemon-reload
sudo systemctl enable evaluation-system
sudo systemctl start evaluation-system
```

### 2. 设置定时备份

```bash
# 编辑 crontab
crontab -e

# 添加每天凌晨 2 点执行备份
0 2 * * * /opt/evaluation-system/scripts/backup.sh
```

### 3. 配置日志轮转

```bash
# 创建日志轮转配置
sudo tee /etc/logrotate.d/evaluation-system > /dev/null << 'EOF'
/opt/evaluation-system/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
    sharedscripts
    postrotate
        systemctl reload evaluation-system > /dev/null 2>&1 || true
    endscript
}
EOF
```

## 常见问题

### Q: 如何更新 API 密钥？

```bash
# 1. 编辑 .env 文件
nano .env

# 2. 更新 DEEPSEEK_API_KEY
DEEPSEEK_API_KEY=sk-new-api-key-here

# 3. 重启服务
sudo systemctl restart evaluation-system
```

### Q: 如何查看系统日志？

```bash
# 查看应用日志
tail -f /opt/evaluation-system/logs/app.log

# 查看 Nginx 日志
tail -f /var/log/nginx/evaluation-system-access.log

# 查看系统日志
sudo journalctl -u evaluation-system -f
```

### Q: 如何备份数据？

```bash
# 手动备份
/opt/evaluation-system/scripts/backup.sh

# 查看备份
ls -lh /opt/evaluation-system/backups/
```

### Q: 如何恢复数据？

```bash
# 1. 停止服务
sudo systemctl stop evaluation-system

# 2. 恢复数据库
cp /opt/evaluation-system/backups/evaluation_20240101_020000.db /opt/evaluation-system/evaluation.db

# 3. 启动服务
sudo systemctl start evaluation-system
```

## 下一步

1. 阅读完整的 `部署指南.md` 了解更多配置选项
2. 阅读 `管理端操作手册.md` 学习如何使用系统
3. 阅读 `教师端操作手册.md` 了解教师如何使用系统

## 支持

如遇到问题，请：

1. 查看 `部署指南.md` 中的故障排查部分
2. 检查日志文件
3. 联系技术支持：support@school.edu

---

**部署时间**：约 35 分钟  
**文档版本**：1.0  
**最后更新**：2024年1月
